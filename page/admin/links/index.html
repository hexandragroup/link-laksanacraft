<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>Tambah Link ‚Äî Admin</title>

<link rel="stylesheet" href="/assets/style/style.css">

<style>
.container-box {
    max-width: 720px;
    margin: 30px auto;
    background: #fff;
    padding: 22px;
    border-radius: 12px;
    box-shadow: 0 8px 22px rgba(0,0,0,.06);
}
h1 { margin-top:0; text-align:center; margin-bottom:20px; }
label { display:block; font-weight:600; margin-bottom:6px; }
.input { width:100%; padding:10px; border:1px solid #dcdcdc; border-radius:8px; font-size:14px; box-sizing:border-box; margin-bottom:12px; }
.actions { display:flex; gap:8px; justify-content:space-between; align-items:center; margin-top:14px; }
.btn { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-size:14px; }
.btn-primary { background:linear-gradient(135deg,#3f51b5,#303f9f); color:#fff; }
.btn-ghost { background:#fafafa; border:1px solid #e6e6e6; color:#333; }
.btn-danger { background:#d32f2f; color:#fff; }
.note { font-size:13px; color:#666; margin-top:8px; }
a.link-back { color:#3f51b5; text-decoration:none; }
</style>
</head>
<body>

<script src="/assets/script/corner-menu.js"></script>

<div class="container-box">
  <h1>Tambah Link</h1>

  <div id="message" style="color:#b30000; margin-bottom:12px"></div>

  <label>Kategori</label>
  <input id="category" class="input" placeholder="Contoh: Sosial Media">

  <label>Judul</label>
  <input id="title" class="input" placeholder="Contoh: Instagram LaksanaCraft">

  <label>URL</label>
  <input id="url" class="input" placeholder="https://...">

  <label>Icon (emoji atau URL icon)</label>
  <input id="icon" class="input" placeholder="Contoh: üîó atau https://...">

  <div class="actions">
    <a href="/page/admin/links/index.html" class="link-back">‚Üê Kembali ke daftar</a>
    <div>
      <button id="btnCancel" class="btn btn-ghost">Batal</button>
      <button id="btnSave" class="btn btn-primary">Simpan Link</button>
    </div>
  </div>
</div>

<script>
const API = "https://ancient-king-d447.hendraslaksono.workers.dev";
const FILE = "data1.json"; // default file
const MSG = document.getElementById('message');

const isLoggedIn = localStorage.getItem("isLoggedIn");
if(!isLoggedIn) location.href="/page/login.html";

const GH_TOKEN = localStorage.getItem("GH_TOKEN") || "";
const API_KEY = localStorage.getItem("LaksanaCraft_API_KEY") || "";

// Cancel
document.getElementById('btnCancel').onclick = (e) => {
    e.preventDefault();
    location.href = "/page/admin/links/index.html";
};

// Save
document.getElementById('btnSave').onclick = async (e) => {
    e.preventDefault();
    MSG.textContent = '';

    const category = document.getElementById('category').value.trim();
    const title = document.getElementById('title').value.trim();
    const url = document.getElementById('url').value.trim();
    const icon = document.getElementById('icon').value.trim();

    if(!category || !title || !url){
        MSG.textContent = 'Lengkapi kategori, judul, dan URL.';
        return;
    }

    // Ambil data file sekarang
    let current = [];
    try{
        const res = await fetch(`${API}/links?file=${FILE}`);
        if(!res.ok) throw new Error('Gagal mengambil file link');
        current = await res.json();
        if(!Array.isArray(current)){
            if(current.content && Array.isArray(current.content)) current = current.content;
            else throw new Error('Format data link tidak sesuai.');
        }
    }catch(err){
        MSG.textContent = 'Gagal memuat data link: ' + err.message;
        return;
    }

    const newId = current.length ? Math.max(...current.map(x=>x.id||0))+1 : 1;

    const newItem = { id:newId, category, title, url, icon };
    current.push(newItem);

    try{
        const res = await fetch(`${API}/links?file=${FILE}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': GH_TOKEN ? `token ${GH_TOKEN}` : '',
                'x-api-key': API_KEY
            },
            body: JSON.stringify(current,null,2)
        });
        const j = await res.json();
        if(res.ok && (j.status==='OK' || j.success || !j.error)){
            location.href = "/page/admin/links/index.html";
        }else{
            MSG.textContent = 'Gagal menyimpan: ' + (j.error || j.message || JSON.stringify(j));
        }
    }catch(err){
        MSG.textContent = 'Gagal menyimpan: ' + err.message;
    }
};
</script>

</body>
</html>