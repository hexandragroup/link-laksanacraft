<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin â€” LaksanaCraft</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style> body { background:#f4f6fb; } </style>
</head>
<body class="py-4 bg-light">

<script>
// proteksi halaman
if (sessionStorage.getItem("isLogin") !== "1") {
  location.href = "login/index.html";
}
</script>

<div class="container">

  <div class="card mb-4">
    <div class="card-body d-flex justify-content-between">
      <h4 class="mb-0">Admin Panel</h4>
      <button class="btn btn-danger" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="card mb-4"><div class="card-body">

    <ul class="nav nav-tabs mb-3">
      <li class="nav-item"><button class="nav-link active" data-tab="products">Produk</button></li>
      <li class="nav-item"><button class="nav-link" data-tab="links">Links</button></li>
    </ul>

    <div class="mb-3">
      <label class="form-label fw-bold">Pilih File JSON</label>
      <select id="fileSelect" class="form-select"></select>
    </div>

    <div class="d-flex justify-content-between mb-2">
      <h6 class="fw-bold">Daftar Item</h6>
      <button class="btn btn-success" id="btnAdd">Tambah Item</button>
    </div>

    <table class="table table-striped" id="dataTable">
      <thead><tr id="theadRow"></tr></thead>
      <tbody id="tbodyData"></tbody>
    </table>

  </div></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

let currentTab = "products";
let data = [];
let editingIndex = null;

// struktur field setiap tab
const structure = {
  products: ["id","tokoh","ukuran","kualitas"],
  links: ["id","title","url"]
};

// file JSON sesuai lokasi GITHUB Anda
const files = {
  products: [
    "products1.json",
    "products2.json",
    "products3.json"
  ],
  links: [
    "data1.json",
    "data2.json",
    "data3.json"
  ]
};

// TAB switching
document.querySelectorAll("[data-tab]").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll("[data-tab]").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    currentTab = btn.dataset.tab;
    loadFileList();
  };
});

function loadFileList() {
  fileSelect.innerHTML = "";
  files[currentTab].forEach(f => {
    const o = document.createElement("option");
    o.value = f;
    o.textContent = f;
    fileSelect.appendChild(o);
  });
  loadFile();
}

async function loadFile() {
  const url = `https://ancient-king-d447.hendraslaksono.workers.dev/${currentTab}?file=${fileSelect.value}`;
  const res = await fetch(url);
  data = await res.json();
  renderTable();
}

function renderTable() {
  const head = structure[currentTab];
  theadRow.innerHTML = head.map(h => `<th>${h}</th>`).join("") + "<th>Aksi</th>";

  tbodyData.innerHTML = "";

  data.forEach((row, i) => {
    const tr = document.createElement("tr");
    head.forEach(h => tr.innerHTML += `<td>${row[h]}</td>`);
    tr.innerHTML += `
      <td>
        <button class="btn btn-warning btn-sm me-1" onclick="openEdit(${i})">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteItem(${i})">Hapus</button>
      </td>`;
    tbodyData.appendChild(tr);
  });
}

btnAdd.onclick = () => {
  editingIndex = null;
  openModal(createEmpty());
};

function openEdit(i) {
  editingIndex = i;
  openModal({...data[i]});
}

function deleteItem(i) {
  if (confirm("Hapus item ini?")) {
    data.splice(i,1);
    saveToServer();
  }
}

function createEmpty() {
  const o = {};
  structure[currentTab].forEach(k => o[k] = "");
  return o;
}

function openModal(obj) {
  let html = "";
  structure[currentTab].forEach(k => {
    html += `
      <label class="form-label">${k}</label>
      <input class="form-control" id="fld_${k}" value="${obj[k] || ""}">
    `;
  });

  const wrapper = document.createElement("div");
  wrapper.className = "p-3 bg-white border rounded";
  wrapper.innerHTML = html;

  const modalContent = document.body.appendChild(wrapper);

  const saveBtn = document.createElement("button");
  saveBtn.className = "btn btn-primary mt-2";
  saveBtn.textContent = "Simpan";

  wrapper.appendChild(saveBtn);

  saveBtn.onclick = () => {
    let o = {};
    structure[currentTab].forEach(k => o[k] = document.getElementById("fld_" + k).value);
    if (editingIndex === null) data.push(o);
    else data[editingIndex] = o;
    saveToServer();
    wrapper.remove();
  };
}

async function saveToServer() {
  await fetch(`https://ancient-king-d447.hendraslaksono.workers.dev/${currentTab}?file=${fileSelect.value}`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(data)
  });
  renderTable();
}

function logout() {
  sessionStorage.removeItem("isLogin");
  location.href = "login/index.html";
}

loadFileList();

</script>

</body>
</html>