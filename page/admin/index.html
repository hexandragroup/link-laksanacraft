<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Panel â€” LaksanaCraft</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#eef1f6; }
    .modal input { margin-bottom:10px; }
  </style>
</head>

<body class="py-4 bg-light">
<div class="container">

  <!-- HEADER -->
  <div class="card mb-4">
    <div class="card-body d-flex justify-content-between">
      <h4 class="mb-0">Admin Panel</h4>
      <button class="btn btn-danger" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- MAIN ADMIN PANEL -->
  <div class="card mb-4">
    <div class="card-body">

      <!-- TABS -->
      <ul class="nav nav-tabs mb-3">
        <li class="nav-item"><button class="nav-link active" data-tab="produk">Produk</button></li>
        <li class="nav-item"><button class="nav-link" data-tab="links">Links</button></li>
      </ul>

      <!-- FILE SELECT -->
      <div class="mb-3">
        <label class="form-label fw-bold">Pilih File JSON</label>
        <select id="fileSelect" class="form-select"></select>
      </div>

      <!-- TABLE + BUTTON -->
      <div class="d-flex justify-content-between mb-2">
        <h6 class="fw-bold">Daftar Item</h6>
        <button class="btn btn-success" id="btnAdd">Tambah Item</button>
      </div>

      <table class="table table-striped" id="dataTable">
        <thead><tr id="theadRow"></tr></thead>
        <tbody id="tbodyData"></tbody>
      </table>

    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Edit Item</h5></div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
      <button class="btn btn-primary" id="saveBtn">Simpan</button>
    </div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
let currentTab = 'produk';
let data = [];
let editingIndex = null;

let structure = {
  produk: ['id','tokoh','ukuran','kualitas'],
  links: ['id','title','url']
};

// file JSON yang akan dipilih dari dropdown
let files = {
  produk: ['products1.json','products2.json','products3.json'],
  links: ['data1.json','data2.json','data3.json']
};

// =========================
// TAB SWITCH
// =========================
document.querySelectorAll("[data-tab]").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll("[data-tab]").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    currentTab = btn.dataset.tab;
    loadFileList();
  };
});

// =========================
// LIST FILE JSON
// =========================
function loadFileList(){
  fileSelect.innerHTML = "";
  files[currentTab].forEach(f=>{
    let o = document.createElement("option");
    o.value = f;
    o.textContent = f;
    fileSelect.appendChild(o);
  });
  loadFile();
}

// =========================
// LOAD DATA FROM WORKER
// =========================
async function loadFile(){
  let filename = fileSelect.value;

  // ARAH FETCH KE WORKER:
  // GET https://ancient-king-d447.hendraslaksono.workers.dev/get?type=produk&file=products1.json

  let url = `https://ancient-king-d447.hendraslaksono.workers.dev/get?type=${currentTab}&file=${filename}`;

  try {
    let res = await fetch(url);
    data = await res.json();
  } catch (e){
    alert("Gagal memuat file JSON dari Worker");
    data = [];
  }

  renderTable();
}

// =========================
// RENDER TABLE
// =========================
function renderTable(){
  const head = structure[currentTab];
  theadRow.innerHTML = head.map(h=>`<th>${h}</th>`).join("") + `<th>Aksi</th>`;
  tbodyData.innerHTML = "";

  data.forEach((row,i)=>{
    const tr = document.createElement("tr");
    head.forEach(h=>{
      tr.innerHTML += `<td>${row[h]}</td>`;
    });
    tr.innerHTML += `
      <td>
        <button class='btn btn-warning btn-sm me-1' onclick='openEdit(${i})'>Edit</button>
        <button class='btn btn-danger btn-sm' onclick='deleteItem(${i})'>Hapus</button>
      </td>
    `;
    tbodyData.appendChild(tr);
  });
}

// =========================
// ADD & EDIT ITEM
// =========================
btnAdd.onclick = ()=>{ editingIndex = null; openModal(createEmptyItem()); };

function createEmptyItem(){
  let obj = {};
  structure[currentTab].forEach(k=> obj[k] = "");
  return obj;
}

function openEdit(i){
  editingIndex = i;
  openModal({...data[i]});
}

function openModal(obj){
  modalBody.innerHTML = "";
  structure[currentTab].forEach(k=>{
    modalBody.innerHTML += `
      <label class='form-label'>${k}</label>
      <input class='form-control' id='fld_${k}' value='${obj[k] ?? ""}'>
    `;
  });
  new bootstrap.Modal(editModal).show();
}

saveBtn.onclick = ()=>{
  let obj={};
  structure[currentTab].forEach(k=>{
    obj[k] = document.getElementById("fld_"+k).value;
  });

  if(editingIndex === null) data.push(obj);
  else data[editingIndex] = obj;

  saveToWorker();
};

// =========================
// DELETE ITEM
// =========================
function deleteItem(i){
  if(confirm("Hapus item ini?")){
    data.splice(i,1);
    saveToWorker();
  }
}

// =========================
// SAVE TO WORKER
// =========================
async function saveToWorker(){
  let filename = fileSelect.value;

  // POST ke Worker
  let url = `https://ancient-king-d447.hendraslaksono.workers.dev/save`;

  let body = {
    type: currentTab,
    file: filename,
    data: data
  };

  let res = await fetch(url,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });

  alert("Perubahan berhasil disimpan");
  renderTable();
}

// =========================
// LOGOUT
// =========================
function logout(){
  location.href = "./login/index.html";
}

loadFileList();
</script>

</body>
</html>