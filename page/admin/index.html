<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin â€” LaksanaCraft</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">

  <div class="card mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <h4>Produk Admin</h4>
      <select id="fileSelect" class="form-select w-auto">
        <option value="products1.json">products1.json</option>
        <option value="products2.json">products2.json</option>
      </select>
      <button id="btnReload" class="btn btn-secondary ms-2">Reload</button>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <table class="table table-striped" id="productsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Tokoh</th>
            <th>Ukuran</th>
            <th>Kualitas</th>
            <th>Link</th>
            <th>Varian</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button id="btnAdd" class="btn btn-success mt-2">Tambah Produk</button>
    </div>
  </div>

</div>

<script>
const API_BASE = "https://ancient-king-d447.hendraslaksono.workers.dev/products";
const API_KEY = localStorage.getItem('LaksanaCraft_API_KEY') || "YOUR_ADMIN_API_KEY_HERE";

let currentFile = "products1.json";
let productsData = [];

// Load data
async function loadData() {
  const res = await fetch(`${API_BASE}?file=${currentFile}`);
  const data = await res.json();
  if(data.error){
    alert("Gagal load: " + data.error);
    return;
  }
  productsData = data;
  renderTable();
}

// Render tabel
function renderTable() {
  const tbody = document.querySelector("#productsTable tbody");
  tbody.innerHTML = "";
  productsData.forEach(prod => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${prod.id}</td>
      <td>${prod.tokoh.join(", ")}</td>
      <td>${prod.ukuran.join(", ")}</td>
      <td>${prod.kualitas}</td>
      <td><a href="${prod.link}" target="_blank">Link</a></td>
      <td>${prod.varian.map(v=>v.size+":"+v.harga).join(" | ")}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="editItem(${prod.id})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteItem(${prod.id})">Hapus</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Tambah produk
document.getElementById("btnAdd").onclick = async () => {
  const tokoh = prompt("Nama tokoh (pisah koma)","Custom").split(",").map(s=>s.trim());
  const ukuran = prompt("Ukuran (pisah koma)","miniatur").split(",").map(s=>s.trim());
  const kualitas = prompt("Kualitas","alusan");
  const link = prompt("Link","https://");
  const varianStr = prompt("Varian (format size:harga, pisah koma)","10cm:Rp11.000,12cm:Rp16.000");
  const varian = varianStr.split(",").map(v=>{
    const [size,harga] = v.split(":");
    return {size:size.trim(),harga:harga.trim()};
  });

  const newItem = {
    id: Math.max(0,...productsData.map(p=>p.id))+1,
    tokoh, ukuran, kualitas, link, varian
  };
  productsData.push(newItem);

  await saveData();
}

// Edit produk
async function editItem(id){
  const prod = productsData.find(p=>p.id===id);
  if(!prod) return alert("Item tidak ditemukan");
  prod.tokoh = prompt("Nama tokoh",prod.tokoh.join(",")).split(",").map(s=>s.trim());
  prod.ukuran = prompt("Ukuran",prod.ukuran.join(",")).split(",").map(s=>s.trim());
  prod.kualitas = prompt("Kualitas",prod.kualitas);
  prod.link = prompt("Link",prod.link);
  const varianStr = prompt("Varian size:harga",prod.varian.map(v=>v.size+":"+v.harga).join(","));
  prod.varian = varianStr.split(",").map(v=>{
    const [size,harga] = v.split(":");
    return {size:size.trim(),harga:harga.trim()};
  });
  await saveData();
}

// Hapus produk
async function deleteItem(id){
  if(!confirm("Hapus item ini?")) return;
  productsData = productsData.filter(p=>p.id!==id);
  await saveData();
}

// Simpan ke worker
async function saveData(){
  const res = await fetch(`${API_BASE}?file=${currentFile}`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "X-API-KEY": API_KEY
    },
    body: JSON.stringify(productsData)
  });
  const j = await res.json();
  if(j.status==="OK"){
    alert("Data tersimpan");
    renderTable();
  } else {
    alert("Gagal simpan: "+(j.error||"Unknown error"));
  }
}

// Dropdown file
document.getElementById("fileSelect").onchange = e=>{
  currentFile = e.target.value;
  loadData();
}
document.getElementById("btnReload").onclick = loadData;

// Load awal
loadData();
</script>

</body>
</html>