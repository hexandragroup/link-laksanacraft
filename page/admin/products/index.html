<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Kelola Produk â€” LaksanaCraft</title>

  <!-- CSS utama -->
  <link rel="stylesheet" href="/assets/style/style.css">

  <!-- CSS khusus admin -->
  <link rel="stylesheet" href="admin-products.css">
</head>
<body>

<script src="/assets/script/corner-menu.js"></script>

<div class="container admin-box">
    <h1>Kelola Produk</h1>
    <p><em>Menampilkan data produk dari API</em></p>

    <button id="btnAdd" class="btn-add">+ Tambah Produk</button>

    <div id="productList"></div>

</div>

<script>
const API = "https://ancient-king-d447.hendraslaksono.workers.dev";
const token = localStorage.getItem("GH_TOKEN");

// Cek login
if (!localStorage.getItem("isLoggedIn")) {
    location.href = "/page/login/";
}

// ESCAPE (hindari XSS)
function escapeHtml(txt) {
    return txt.replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;',
        '"': '&quot;', "'": '&#039;'
    }[m]));
}

// LOAD DATA PRODUK
async function loadProducts() {
    const res = await fetch(`${API}/products?file=products1.json`, {
        headers: { "Authorization": `token ${token}` }
    });

    const data = await res.json();
    const wrap = document.getElementById("productList");
    wrap.innerHTML = "";

    data.forEach((p, i) => {

        let tokoh = Array.isArray(p.tokoh) ? p.tokoh.join(", ") : p.tokoh;
        let ukuran = p.ukuran || "-";
        let kualitas = p.kualitas || "-";
        let link = escapeHtml(p.link || "#");

        wrap.innerHTML += `
        <div class="item-box">

            <div class="result">
                <p><strong>Tokoh:</strong> ${escapeHtml(tokoh)}</p>
                <p><strong>Kualitas:</strong> ${escapeHtml(kualitas)}</p>
                <p><strong>Ukuran:</strong> ${escapeHtml(ukuran)}</p>
                <p><a href="${link}" target="_blank">ðŸ”— Detail Produk</a></p>
            </div>

            <div class="action">
                <button class="btn-edit" onclick="editItem(${i})">Edit</button>
                <button class="btn-delete" onclick="deleteItem(${i})">Hapus</button>
            </div>

        </div>`;
    });
}

loadProducts();


// -------------------------
// HAPUS ITEM
// -------------------------
async function deleteItem(index) {
    if (!confirm("Yakin ingin menghapus item ini?")) return;

    const res = await fetch(`${API}/products?file=products1.json`, {
        method: "DELETE",
        headers: {
            "Authorization": `token ${token}`,
            "X-Item-Index": index
        }
    });

    if (res.ok) {
        alert("Berhasil dihapus");
        loadProducts();
    } else {
        alert("Gagal menghapus");
    }
}

// -------------------------
// EDIT ITEM (Akan buka popup form)
// -------------------------
function editItem(i) {
    location.href = `edit.html?id=${i}`;
}

// TAMBAH ITEM
document.getElementById("btnAdd").onclick = () => {
    location.href = "add.html";
};
</script>

</body>
</html>